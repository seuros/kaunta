<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico" />
    <link rel="stylesheet" href="/assets/global.css" />
    <meta name="robots" content="noindex, nofollow" />
    <title>Setup - Kaunta</title>
    <style>
      /* Setup-specific styles */
      body {
        background: var(--bg-primary);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: var(--space-lg);
      }
      .setup-container {
        background: var(--glass-bg);
        backdrop-filter: blur(10px);
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-xl);
        width: 100%;
        max-width: 800px;
        padding: var(--space-2xl);
      }
      .logo {
        text-align: center;
        margin-bottom: var(--space-2xl);
      }
      .logo h1 {
        font-size: var(--font-3xl);
        margin-bottom: var(--space-sm);
      }
      .form-section {
        margin-bottom: var(--space-2xl);
      }
      .section-title {
        font-size: var(--font-xl);
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--space-lg);
        padding-bottom: var(--space-sm);
        border-bottom: 2px solid var(--border-color);
        display: flex;
        align-items: center;
        gap: var(--space-sm);
      }
      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--space-lg);
        align-items: start;
      }
      .form-row .form-group input,
      .form-row .form-group select {
        width: 100%;
      }
      .form-group input,
      .form-group select {
        width: 100%;
      }
      .form-actions {
        display: flex;
        gap: var(--space-md);
        margin-top: var(--space-2xl);
        padding-top: var(--space-lg);
        border-top: 1px solid var(--border-color);
        justify-content: space-between;
        align-items: center;
      }
      .setup-container input.error {
        border-color: var(--error-color);
        box-shadow: 0 0 0 3px rgb(239 68 68 / 15%);
      }
      .password-strength {
        height: 4px;
        background: var(--glass-bg);
        border-radius: 2px;
        margin-top: var(--space-xs);
        overflow: hidden;
        border: 1px solid var(--border-color);
      }
      .password-strength-bar {
        height: 100%;
        transition:
          width var(--transition-slow),
          background-color var(--transition-slow);
      }
      .strength-weak {
        width: 33%;
        background: var(--error-color);
      }
      .strength-medium {
        width: 66%;
        background: #f59e0b;
      }
      .strength-strong {
        width: 100%;
        background: var(--success-color);
      }
      /* Responsive adjustments */
      @media (max-width: 768px) {
        body {
          padding: var(--space-md);
        }
        .setup-container {
          padding: var(--space-lg);
        }
        .form-row {
          grid-template-columns: 1fr;
        }
        .form-actions {
          flex-direction: column;
          align-items: stretch;
        }
        .form-actions > div {
          order: 2;
          text-align: center;
          margin-top: var(--space-sm);
        }
        .form-actions .btn {
          order: 1;
        }
      }
    </style>
  </head>
  <body>
    <div
      class="setup-container"
      id="setup-container"
      data-signals="{
        form: {
          db_host: 'localhost',
          db_port: '5432',
          db_name: '',
          db_user: 'postgres',
          db_password: '',
          db_ssl_mode: 'disable',
          server_port: '3000',
          data_dir: './data',
          admin_username: '',
          admin_name: '',
          admin_password: '',
          admin_password_confirm: ''
        },
        message: '',
        messageType: 'info',
        testing: false,
        submitting: false,
        passwordStrength: 0,
        passwordStrengthClass: '',
        redirect: '',
        redirecting: false
      }"
    >
      <div class="logo">
        <h1>Kaunta</h1>
        <p class="subtitle">Initial Setup</p>
      </div>
      <!-- Status Messages -->
      <div data-show="$message">
        <div class="error-message" data-show="$messageType === 'error'" data-text="$message"></div>
        <div
          class="alert alert-success"
          data-show="$messageType === 'success'"
          data-text="$message"
          style="
            background: rgb(16 185 129 / 10%);
            color: var(--success-color);
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-md);
            border: 1px solid rgb(16 185 129 / 20%);
          "
        ></div>
        <div
          class="alert alert-info"
          data-show="$messageType === 'info'"
          data-text="$message"
          style="
            background: rgb(59 130 246 / 10%);
            color: var(--accent-color);
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-md);
            border: 1px solid rgb(59 130 246 / 20%);
          "
        ></div>
      </div>
      <form
        data-on:submit__prevent="
          if ($form.admin_password !== $form.admin_password_confirm) {
            $message = 'Passwords do not match';
            $messageType = 'error';
            return;
          }
          if ($form.admin_username && !/^[a-zA-Z0-9_]+$/.test($form.admin_username)) {
            $message = 'Username can only contain letters, numbers, and underscores';
            $messageType = 'error';
            return;
          }
          $submitting = true;
          $message = '';
          $messageType = 'info';
          @post('/setup', { body: $form })
        "
      >
        <!-- Database Configuration -->
        <div class="form-section">
          <h2 class="section-title">Database Configuration</h2>
          <p class="help-text" style="margin-bottom: var(--space-lg)">
            Kaunta requires <strong>PostgreSQL 18+</strong> (uses UUIDv7, virtual columns, async
            I/O, and advanced analytics functions)
          </p>
          <div class="form-row">
            <div class="form-group">
              <label for="db_host">Host *</label>
              <input
                type="text"
                id="db_host"
                name="db_host"
                class="input focus-ring"
                data-bind:form.db_host
                required
              />
            </div>
            <div class="form-group">
              <label for="db_port">Port *</label>
              <input
                type="text"
                id="db_port"
                name="db_port"
                class="input focus-ring"
                data-bind:form.db_port
                required
              />
            </div>
          </div>
          <div class="form-group">
            <label for="db_name">Database Name *</label>
            <input
              type="text"
              id="db_name"
              name="db_name"
              class="input focus-ring"
              data-bind:form.db_name
              required
            />
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="db_user">Username *</label>
              <input
                type="text"
                id="db_user"
                name="db_user"
                class="input focus-ring"
                data-bind:form.db_user
                required
              />
            </div>
            <div class="form-group">
              <label for="db_password">Password</label>
              <input
                type="password"
                id="db_password"
                name="db_password"
                class="input focus-ring"
                data-bind:form.db_password
              />
              <small>Leave empty if not required</small>
            </div>
          </div>
          <div class="form-group">
            <label for="db_ssl_mode">SSL Mode</label>
            <select
              id="db_ssl_mode"
              name="db_ssl_mode"
              class="focus-ring"
              data-bind:form.db_ssl_mode
            >
              <option value="disable">Disable</option>
              <option value="require">Require</option>
              <option value="verify-ca">Verify CA</option>
              <option value="verify-full">Verify Full</option>
            </select>
          </div>
          <button
            type="button"
            class="btn btn-secondary"
            data-on:click="
              $testing = true;
              $message = '';
              $messageType = 'info';
              @post('/setup/test-db', { body: {
                db_host: $form.db_host,
                db_port: $form.db_port,
                db_name: $form.db_name,
                db_user: $form.db_user,
                db_password: $form.db_password,
                db_ssl_mode: $form.db_ssl_mode
              }})
            "
            data-attr:disabled="$testing"
          >
            <span data-show="!$testing">Test Database Connection</span>
            <span data-show="$testing" class="spinner"></span>
          </button>
        </div>
        <!-- Server Configuration -->
        <div class="form-section">
          <h2 class="section-title">Server Configuration</h2>
          <div class="form-row">
            <div class="form-group">
              <label for="server_port">Server Port</label>
              <input
                type="text"
                id="server_port"
                name="server_port"
                class="input focus-ring"
                data-bind:form.server_port
              />
              <small>Default: 3000</small>
            </div>
            <div class="form-group">
              <label for="data_dir">Data Directory</label>
              <input
                type="text"
                id="data_dir"
                name="data_dir"
                class="input focus-ring"
                data-bind:form.data_dir
              />
              <small>For GeoIP database</small>
            </div>
          </div>
        </div>
        <!-- Admin User -->
        <div class="form-section">
          <h2 class="section-title">Administrator Account</h2>
          <div class="form-group">
            <label for="admin_username">Username *</label>
            <input
              type="text"
              id="admin_username"
              name="admin_username"
              class="input focus-ring"
              data-bind:form.admin_username
              data-class:error="$form.admin_username && !/^[a-zA-Z0-9_]+$/.test($form.admin_username)"
              required
              minlength="3"
              maxlength="30"
              pattern="[a-zA-Z0-9_]+"
            />
            <small>3-30 characters, letters, numbers, and underscores only</small>
          </div>
          <div class="form-group">
            <label for="admin_name">Full Name</label>
            <input
              type="text"
              id="admin_name"
              name="admin_name"
              class="input focus-ring"
              data-bind:form.admin_name
              placeholder="Optional"
            />
          </div>
          <div class="form-group">
            <label for="admin_password">Password *</label>
            <input
              type="password"
              id="admin_password"
              name="admin_password"
              class="input focus-ring"
              data-bind:form.admin_password
              data-on:input="
                let pwd = $form.admin_password;
                let len = pwd.length;
                let hasCase = /[A-Z]/.test(pwd) && /[a-z]/.test(pwd);
                let hasNum = /[0-9]/.test(pwd);
                let hasSpecial = /[^A-Za-z0-9]/.test(pwd);
                $passwordStrength =
                  (len >= 8 ? 1 : 0) +
                  (len >= 12 ? 1 : 0) +
                  (hasCase ? 1 : 0) +
                  (hasNum ? 1 : 0) +
                  (hasSpecial ? 1 : 0);
                $passwordStrengthClass =
                  $passwordStrength <= 2 ? 'strength-weak' :
                  $passwordStrength <= 3 ? 'strength-medium' :
                  'strength-strong';
              "
              required
              minlength="8"
            />
            <div class="password-strength" data-show="$form.admin_password">
              <div
                class="password-strength-bar"
                data-class:strength-weak="$passwordStrengthClass === 'strength-weak'"
                data-class:strength-medium="$passwordStrengthClass === 'strength-medium'"
                data-class:strength-strong="$passwordStrengthClass === 'strength-strong'"
              ></div>
            </div>
            <small>Minimum 8 characters</small>
          </div>
          <div class="form-group">
            <label for="admin_password_confirm">Confirm Password *</label>
            <input
              type="password"
              id="admin_password_confirm"
              name="admin_password_confirm"
              class="input focus-ring"
              data-bind:form.admin_password_confirm
              required
              minlength="8"
            />
          </div>
        </div>
        <!-- Form Actions -->
        <div class="form-actions">
          <div>
            <small style="color: var(--text-tertiary)">* Required fields</small>
          </div>
          <button type="submit" class="btn btn-primary" data-attr:disabled="$submitting">
            <span data-show="!$submitting">Complete Setup</span>
            <span data-show="$submitting" class="spinner"></span>
          </button>
        </div>
      </form>
      <div
        aria-hidden="true"
        style="display: none"
        data-effect="
          if ($redirect && !$redirecting) {
            $redirecting = true;
            const target = $redirect || '/dashboard';
            const poll = async () => {
              try {
                const res = await fetch('/up', { cache: 'no-store' });
                if (res.ok) {
                  window.location.href = target;
                  return;
                }
              } catch (err) {
                console.warn('Waiting for main server to come back online', err);
              }
              setTimeout(poll, 1500);
            };
            poll();
          }
        "
      ></div>
    </div>
    <script type="module" src="/assets/vendor/vendor.js"></script>
  </body>
</html>
